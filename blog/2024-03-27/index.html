<!DOCTYPE html><html  lang="fr"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Metro Travel</title><style>/*! tailwindcss v4.1.11 | MIT License | https://tailwindcss.com */@layer properties{@supports ((-webkit-hyphens:none) and (not (margin-trim:inline))) or ((-moz-orient:inline) and (not (color:rgb(from red r g b)))){*,::backdrop,:after,:before{--tw-font-weight:initial;--tw-leading:initial}}}.post h1{font-size:var(--text-4xl,2.25rem);line-height:var(--tw-leading,var(--text-4xl--line-height,1.11111));--tw-font-weight:var(--font-weight-bold,700);color:var(--color-gray-900,oklch(21% .034 264.665));font-weight:var(--font-weight-bold,700);padding-bottom:2rem}.post h2{font-size:var(--text-3xl,1.875rem);line-height:var(--tw-leading,var(--text-3xl--line-height,1.2));--tw-font-weight:var(--font-weight-semibold,600);color:var(--color-gray-800,oklch(27.8% .033 256.848));font-weight:var(--font-weight-semibold,600)}.post p{font-size:var(--text-base,1rem);line-height:var(--tw-leading,var(--text-base--line-height,1.5));--tw-leading:var(--leading-relaxed,1.625);color:var(--color-gray-700,oklch(37.3% .034 259.733));line-height:var(--leading-relaxed,1.625)}.post ul{list-style-position:inside;list-style-type:disc}.post a{color:var(--color-blue-600,oklch(54.6% .245 262.881));text-decoration-line:underline}@media (hover:hover){.post a:hover{color:var(--color-blue-800,oklch(42.4% .199 265.638))}}@property --tw-font-weight{syntax:"*";inherits:false}@property --tw-leading{syntax:"*";inherits:false}</style><style>pre code .line{display:block}</style><link rel="stylesheet" href="/_nuxt/entry.D0eQ7gLW.css" crossorigin><link rel="preload" as="fetch" crossorigin="anonymous" href="/blog/2024-03-27/_payload.json?d002b2d4-7063-42d0-8888-5547bfabd298"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/xtOTLKHp.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/B6OLWuwh.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/p1vkQy-1.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/CBzfIoK6.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/DecUcFKb.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/DTXG7hKP.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/B1jbzOwC.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/BVyUBhLY.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/D-hlhtvc.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/CL5PJvcM.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/BcB6_aqD.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/CFUHJ3Jn.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/lQ9EVNRR.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/CoIEo3mS.js"><link rel="preload" as="fetch" fetchpriority="low" crossorigin="anonymous" href="/_nuxt/builds/meta/d002b2d4-7063-42d0-8888-5547bfabd298.json"><script src="https://analytics.vincenthardouin.dev/js/script.js" defer data-domain="metro-travel.vincenthardouin.dev"></script><link rel="prefetch" as="script" crossorigin href="/_nuxt/Cnsg1qAK.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/DOw0PMhc.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/DAzw92B2.js"><meta hid="description" name="description" content="D√©fiez vos connaissances du m√©tro parisien chaque jour en trouvant le trajet optimal."><meta name="keywords" content="metro, paris, travel, challenge, game, daily, GTFS"><meta name="author" content="Vincent Hardouin"><meta name="robots" content="index, follow"><meta name="og:title" content="Metro travel"><link rel="icon" type="image/png" href="/favicon.png"><script type="module" src="/_nuxt/xtOTLKHp.js" crossorigin></script><script id="unhead:payload" type="application/json">{"title":"Metro Travel"}</script></head><body><div id="__nuxt"><div><body class="bg-gray-100 dark:bg-gray-900 font-sans transition-colors duration-300"><header class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-white/70 dark:bg-gray-800/70 backdrop-blur-lg px-3 py-3 rounded-full shadow-lg flex justify-between items-center z-10 w-[calc(100%-2rem)] max-w-[640px] mx-auto transition-colors duration-300"><div class="text-m md:text-lg font-bold text-gray-800 dark:text-gray-200 whitespace-nowrap px-1 md:px-3"> üöá Metro Travel </div><div class="flex items-center gap-2 md:gap-6"><ul class="hidden sm:flex gap-2 md:gap-4 items-center"><li><a href="/" class="text-sm md:text-base font-medium hover:text-primary no-underline"> Accueil </a></li><li><a href="/blog" class="text-sm md:text-base font-medium hover:text-primary no-underline"> Blog </a></li></ul><a href="/training" class="btn btn-primary btn-sm shadow-none px-4 py-2 rounded-full text-sm font-semibold whitespace-nowrap"> S&#39;entra√Æner </a></div></header><!--[--><article class="post max-w-3xl mx-auto pt-34 py-12 px-4 prose prose-gray dark:prose-invert prose prose-lg dark:prose-invert leading-relaxed"><div><h1 id="_2024-03-27"><!--[-->2024-03-27<!--]--></h1><p><!--[-->Cette migration vers l&#39;usage de GTFS est plut√¥t int√©ressante. Cela me permet de r√©soudre plusieurs choses :<!--]--></p><ul><!--[--><li><!--[-->Avoir un mode par temps de trajet<!--]--></li><li><!--[-->Avoir un affichage des stations plus pr√©cises (l&#39;unique point par station)<!--]--></li><li><!--[-->Avoir toutes les correspondances possibles (ex: Saint-Lazare - St-Augustin)<!--]--></li><li><!--[-->√ätre en mesure d&#39;ajouter le RER, le bus, le tramway, etc.<!--]--></li><li><!--[-->√ätre en mesure de pouvoir faire d&#39;autres villes avec quelques changements<!--]--></li><!--]--></ul><h2 id="import-des-donn√©es"><a href="#import-des-donn√©es"><!--[-->Import des donn√©es<!--]--></a></h2><p><!--[-->Hier, je me suis arr√™t√© √† un moment o√π je streamais les donn√©es pars√©es pour les enregistrer en base de donn√©es.
Seulement, √† la fin du script, je n&#39;avais pas tout en base. Regardons de plus pr√®s.<!--]--></p><pre class="language-shell shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span>‚ùØ wc -l ~/Downloads/IDFM-gtfs/trips.txt
</span></span><span class="line" line="2"><span>  440474 /Users/vincenthardouin/Downloads/IDFM-gtfs/trips.txt
</span></span></code><!--]--></pre><p><!--[-->Il y a 440 474 lignes dans le fichier
<code><!--[-->trips.txt<!--]--></code>, moins 1 ligne de header et j&#39;ai 433 lignes dans ma base de donn√©es.<!--]--></p><pre class="language-shell shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span>‚ùØ pgcli postgresql://postgres@localhost:5432/idfm
</span></span><span class="line" line="2"><span>Server: PostgreSQL 14.10
</span></span><span class="line" line="3"><span>Version: 4.0.1
</span></span><span class="line" line="4"><span>Home: http://pgcli.com
</span></span><span class="line" line="5"><span>postgres@localhost:idfm&gt; select count(*) from trips;
</span></span><span class="line" line="6"><span>+-------+
</span></span><span class="line" line="7"><span>| count |
</span></span><span class="line" line="8"><span>|-------|
</span></span><span class="line" line="9"><span>| 433   |
</span></span><span class="line" line="10"><span>+-------+
</span></span><span class="line" line="11"><span>SELECT 1
</span></span><span class="line" line="12"><span>Time: 0.014s
</span></span></code><!--]--></pre><p><!--[-->Une l√©g√®re diff√©rence ‚Ä¶<!--]--></p><p><!--[-->Voici mon impl√©mentation de stream :<!--]--></p><pre class="language-javascript shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span>await new Promise((resolve, reject) =&gt; {
</span></span><span class="line" line="2"><span>  stream.on(&#39;data&#39;, async (chunk) =&gt; {
</span></span><span class="line" line="3"><span>    await saveFunction([chunk]);
</span></span><span class="line" line="4"><span>  });
</span></span><span class="line" line="5"><span>  stream.on(&#39;end&#39;, () =&gt; {
</span></span><span class="line" line="6"><span>    resolve();
</span></span><span class="line" line="7"><span>  });
</span></span><span class="line" line="8"><span>  stream.on(&#39;error&#39;, (error) =&gt; {
</span></span><span class="line" line="9"><span>    reject(error);
</span></span><span class="line" line="10"><span>  });
</span></span><span class="line" line="11"><span>});
</span></span></code><!--]--></pre><p><!--[-->Je suppose que l&#39;async callback ne fonctionne pas, ce qui parait assez logique.
Je transforme donc le code sous cette forme :<!--]--></p><pre class="language-javascript shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span>for await (const chunk of stream) {
</span></span><span class="line" line="2"><span>  await saveFunction([chunk]);
</span></span><span class="line" line="3"><span>}
</span></span></code><!--]--></pre><p><!--[-->Je relance le script, c&#39;est long, mais √ßa fonctionne bien. L√†, on commit 1 √† 1 chaque ligne.
Je me dis que je peux envoyer des batchs :<!--]--></p><pre class="language-javascript shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span>for await (const data of stream) {
</span></span><span class="line" line="2"><span>  chunks.push(data);
</span></span><span class="line" line="3"><span>  if (chunks.length &gt; 10000) {
</span></span><span class="line" line="4"><span>    await saveFunction(chunks);
</span></span><span class="line" line="5"><span>    chunks = [];
</span></span><span class="line" line="6"><span>  }
</span></span><span class="line" line="7"><span>}
</span></span></code><!--]--></pre><p><!--[-->Je relance le script, c&#39;est plus rapide. On commit par batch de 1000 lignes. 10 secondes pour 413 000 lignes, testons
par 10 000. J&#39;augmente donc √† 10 000 la taille du batch de cette fonction est aussi dans le batchInsert de knex, j&#39;ai
les m√™mes r√©sultats. Je reste √† 1 000.<!--]--></p><p><!--[-->Oups, durant l&#39;import, j&#39;ai l&#39;erreur :
<code><!--[--> hint: &#39;Check free disk space.&#39;,<!--]--></code>. Je ne dois pas allouer assez de place pour
docker.
Mais la base est si grosse que √ßa ? Je regarde :<!--]--></p><pre class="language-shell shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span>postgres@localhost:idfm&gt; SELECT pg_size_pretty( pg_database_size(&#39;idfm&#39;) );
</span></span><span class="line" line="2"><span>+----------------+
</span></span><span class="line" line="3"><span>| pg_size_pretty |
</span></span><span class="line" line="4"><span>|----------------|
</span></span><span class="line" line="5"><span>| 1912 MB        |
</span></span><span class="line" line="6"><span>+----------------+
</span></span><span class="line" line="7"><span>SELECT 1
</span></span><span class="line" line="8"><span>Time: 0.033s
</span></span></code><!--]--></pre><p><!--[-->Ah 2 Go quand m√™me. Bon, na√Øvement, je lance un
<code><!--[-->docker system prune<!--]--></code>. Je r√©cup√®re 3Go.
Je relance. En 4 minutes 55, j&#39;ai tout en base. Je ne sais pas quoi en penser niveau performance, mais ce n&#39;est d√©j√† pas
si mal.
Le map sur les 1000 √©l√©ments √† chaque insertion ne doit pas aider, mais ce n&#39;est pas le sujet.<!--]--></p><p><!--[-->Je vais pouvoir passer aux requ√™tes sql pour r√©cup√©rer les donn√©es.<!--]--></p><h2 id="export-des-donn√©es"><a href="#export-des-donn√©es"><!--[-->Export des donn√©es<!--]--></a></h2><p><!--[-->Hier, j&#39;ai fait un semblant de json qui me plairait bien :<!--]--></p><pre class="language-json shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span class="sVt8B">{
</span></span><span class="line" line="2"><span class="sj4cs">  &quot;routes&quot;</span><span class="sVt8B">: [
</span></span><span class="line" line="3"><span class="sVt8B">    {
</span></span><span class="line" line="4"><span class="sj4cs">      &quot;route_id&quot;</span><span class="sVt8B">: </span><span class="sZZnC">&quot;route_id&quot;</span><span class="sVt8B">,
</span></span><span class="line" line="5"><span class="sj4cs">      &quot;route_name&quot;</span><span class="sVt8B">: </span><span class="sZZnC">&quot;route_name&quot;</span><span class="sVt8B">,
</span></span><span class="line" line="6"><span class="sj4cs">      &quot;route_color&quot;</span><span class="sVt8B">: </span><span class="sZZnC">&quot;route_color&quot;
</span></span><span class="line" line="7"><span class="sVt8B">    }
</span></span><span class="line" line="8"><span class="sVt8B">  ],
</span></span><span class="line" line="9"><span class="sj4cs">  &quot;stops&quot;</span><span class="sVt8B">: [
</span></span><span class="line" line="10"><span class="sVt8B">    {
</span></span><span class="line" line="11"><span class="sj4cs">      &quot;name&quot;</span><span class="sVt8B">: </span><span class="sZZnC">&quot;stop_name&quot;</span><span class="sVt8B">,
</span></span><span class="line" line="12"><span class="sj4cs">      &quot;id&quot;</span><span class="sVt8B">: </span><span class="sZZnC">&quot;stop_id&quot;</span><span class="sVt8B">,
</span></span><span class="line" line="13"><span class="sj4cs">      &quot;stop_unique_id&quot;</span><span class="sVt8B">: </span><span class="sZZnC">&quot;stop_unique_id&quot;</span><span class="sVt8B">,
</span></span><span class="line" line="14"><span class="sj4cs">      &quot;route_id&quot;</span><span class="sVt8B">: </span><span class="sZZnC">&quot;route_id&quot;
</span></span><span class="line" line="15"><span class="sVt8B">    }
</span></span><span class="line" line="16"><span class="sVt8B">  ],
</span></span><span class="line" line="17"><span class="sj4cs">  &quot;adjacents&quot;</span><span class="sVt8B">: [
</span></span><span class="line" line="18"><span class="sVt8B">    {
</span></span><span class="line" line="19"><span class="sj4cs">      &quot;from_stop_id&quot;</span><span class="sVt8B">: </span><span class="sZZnC">&quot;stop_id&quot;</span><span class="sVt8B">,
</span></span><span class="line" line="20"><span class="sj4cs">      &quot;to_stop_id&quot;</span><span class="sVt8B">: </span><span class="sZZnC">&quot;adjacent_stop_id&quot;</span><span class="sVt8B">,
</span></span><span class="line" line="21"><span class="sj4cs">      &quot;time&quot;</span><span class="sVt8B">: </span><span class="sj4cs">123</span><span class="sVt8B">,
</span></span><span class="line" line="22"><span class="sj4cs">      &quot;path&quot;</span><span class="sVt8B">: [
</span></span><span class="line" line="23"><span class="sVt8B">        {
</span></span><span class="line" line="24"><span class="sj4cs">          &quot;lat&quot;</span><span class="sVt8B">: </span><span class="sj4cs">48.123</span><span class="sVt8B">,
</span></span><span class="line" line="25"><span class="sj4cs">          &quot;lon&quot;</span><span class="sVt8B">: </span><span class="sj4cs">2.123
</span></span><span class="line" line="26"><span class="sVt8B">        }
</span></span><span class="line" line="27"><span class="sVt8B">      ]
</span></span><span class="line" line="28"><span class="sVt8B">    }
</span></span><span class="line" line="29"><span class="sVt8B">  ],
</span></span><span class="line" line="30"><span class="sj4cs">  &quot;stops_unique&quot;</span><span class="sVt8B">: [
</span></span><span class="line" line="31"><span class="sVt8B">    {
</span></span><span class="line" line="32"><span class="sj4cs">      &quot;id&quot;</span><span class="sVt8B">: </span><span class="sZZnC">&quot;stop_unique_id&quot;</span><span class="sVt8B">,
</span></span><span class="line" line="33"><span class="sj4cs">      &quot;name&quot;</span><span class="sVt8B">: </span><span class="sZZnC">&quot;stop_name&quot;</span><span class="sVt8B">,
</span></span><span class="line" line="34"><span class="sj4cs">      &quot;lat&quot;</span><span class="sVt8B">: </span><span class="sj4cs">48.123</span><span class="sVt8B">,
</span></span><span class="line" line="35"><span class="sj4cs">      &quot;lon&quot;</span><span class="sVt8B">: </span><span class="sj4cs">2.123
</span></span><span class="line" line="36"><span class="sVt8B">    }
</span></span><span class="line" line="37"><span class="sVt8B">  ]
</span></span><span class="line" line="38"><span class="sVt8B">}
</span></span></code><!--]--></pre><h3 id="routes"><a href="#routes"><!--[-->Routes<!--]--></a></h3><p><!--[-->Je commence par les routes, dans mon cas, je ne veux que les lignes de m√©tros.
En basant sur <a href="/blog/assets/IDFM_Documentation_GTFS.pdf" class=""><!--[-->le document GTFS de IDFM<!--]--></a>, je peux voir que le
<code><!--[-->route_type<!--]--></code> est √† 1
pour les m√©tros. Faisons du TDD, apr√®s ce moment sans tests, pour l&#39;import.<!--]--></p><h3 id="stops"><a href="#stops"><!--[-->Stops<!--]--></a></h3><p><!--[-->Ensuite, les stops, √ßa va √™tre plus sympa. Pour les stops, il faut faire la jointure avec
<code><!--[-->stop_times<!--]--></code>, puis
<code><!--[-->trips<!--]--></code>, et
les li√©s aux
<code><!--[-->routes<!--]--></code>.
En faisant cette requ√™te :<!--]--></p><pre class="language-sql shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span>select distinct(stop_name)
</span></span><span class="line" line="2"><span>from stops
</span></span><span class="line" line="3"><span>inner join stop_times on stops.stop_id = stop_times.stop_id
</span></span><span class="line" line="4"><span>inner join trips on trips.trip_id = stop_times.trip_id
</span></span><span class="line" line="5"><span>inner join routes on routes.route_id = trips.route_id
</span></span><span class="line" line="6"><span>where routes.route_type = 1;
</span></span></code><!--]--></pre><p><!--[-->J&#39;ai la r√©ponse en 2s, et 0.6s au deuxi√®me appel (avec du cache). C&#39;est clairement OK, merci PG &lt;3.<!--]--></p><h3 id="adjacents"><a href="#adjacents"><!--[-->Adjacents<!--]--></a></h3><p><!--[-->Pour les adjacents, il y a plusieurs calculs √† faire.<!--]--></p><h3 id="adjacents-sur-une-m√™me-ligne"><a href="#adjacents-sur-une-m√™me-ligne"><!--[-->Adjacents sur une m√™me ligne<!--]--></a></h3><p><!--[-->Il faut d&#39;abord r√©cup√©rer les adjacents sur une m√™me ligne, pour √ßa il faut se baser sur les
<code><!--[-->stop_times<!--]--></code> gr√¢ce
au
<code><!--[-->stop_sequence<!--]--></code>.
Si la station a un
<code><!--[-->stop_sequence<!--]--></code> de 5, alors ses adjacents sont les stations 4 et 6.<!--]--></p><p><!--[-->J&#39;obtiens quelque chose avec cette requ√™te :<!--]--></p><pre class="language-sql shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span>SELECT DISTINCT s.stop_name AS station_name,
</span></span><span class="line" line="2"><span>        st.stop_sequence AS current_sequence,
</span></span><span class="line" line="3"><span>        adjacent_stops.stop_sequence AS adjacent_sequence,
</span></span><span class="line" line="4"><span>        adjacent_stops_station.stop_name AS adjacent_station_name,
</span></span><span class="line" line="5"><span>        r.route_short_name AS line_number
</span></span><span class="line" line="6"><span> FROM stop_times AS st
</span></span><span class="line" line="7"><span> INNER JOIN stop_times AS adjacent_stops ON st.trip_id = adjacent_stops.trip_id
</span></span><span class="line" line="8"><span> INNER JOIN stops AS s ON st.stop_id = s.stop_id
</span></span><span class="line" line="9"><span> INNER JOIN stops AS adjacent_stops_station ON adjacent_stops.stop_id = adjacent_stops_station.stop_id
</span></span><span class="line" line="10"><span> INNER JOIN trips AS t ON st.trip_id = t.trip_id
</span></span><span class="line" line="11"><span> INNER JOIN routes AS r ON t.route_id = r.route_id
</span></span><span class="line" line="12"><span> WHERE ABS(st.stop_sequence - adjacent_stops.stop_sequence) = 1
</span></span><span class="line" line="13"><span> AND r.route_type = 1;
</span></span></code><!--]--></pre><p><!--[-->Elle met 5s, c&#39;est plut√¥t correct sur 9 millions de lignes et pour un one-shot.<!--]--></p><p><!--[-->Ce qui m&#39;√©tonne avec cette requ√™te, c&#39;est que par exemple si on prends Al√©sia, on a :<!--]--></p><pre class="language-text"><!--[--><code>+-----------------------------------------+------------------+-------------------+-------------------------------------+-------------+
| station_name                            | current_sequence | adjacent_sequence | adjacent_station_name               | line_number |
|-----------------------------------------+------------------+-------------------+-------------------------------------+-------------|
| Al√©sia                                  | 1                | 0                 | Porte d&#39;Orl√©ans                     | 4           |
| Al√©sia                                  | 1                | 2                 | Mouton-Duvernet                     | 4           |
| Al√©sia                                  | 4                | 3                 | Porte d&#39;Orl√©ans                     | 4           |
| Al√©sia                                  | 4                | 5                 | Mouton-Duvernet                     | 4           |
| Al√©sia                                  | 19               | 18                | Mouton-Duvernet                     | 4           |
| Al√©sia                                  | 19               | 20                | Porte d&#39;Orl√©ans                     | 4           |
| Al√©sia                                  | 24               | 23                | Mouton-Duvernet                     | 4           |
| Al√©sia                                  | 24               | 25                | Porte d&#39;Orl√©ans                     | 4           |
</code><!--]--></pre><p><!--[-->On peut voir les aller-retour par exemple dans un sens, Al√©sia et la deuxi√®me station (current_sequence = 1) et a donc
comme stations adjacentes : Porte d&#39;Orl√©ans et Mouton-Duvernet.
Dans l&#39;autre sens, Al√©sia, c&#39;est la 19e station avec les m√™mes stations adjacentes. Mais, c&#39;est aussi la 4e station et
la 19e, comme si la ligne √©tait raccourcie √† un moment donn√© ou rallong√©e d&#39;ailleurs.<!--]--></p><p><!--[-->Si j&#39;affiche le
<code><!--[-->trip_headsign<!--]--></code>, je pourrais en savoir plus<!--]--></p><pre class="language-text"><!--[--><code>+-----------------------------------------+------------------+-------------------+-------------------------------------+-------------+-------------------------------------------------+
| station_name                            | current_sequence | adjacent_sequence | adjacent_station_name               | line_number | trip_name                                       |
|-----------------------------------------+------------------+-------------------+-------------------------------------+-------------+-------------------------------------------------|
| Al√©sia                                  | 1                | 0                 | Porte d&#39;Orl√©ans                     | 4           | Porte de Clignancourt                           |
| Al√©sia                                  | 1                | 2                 | Mouton-Duvernet                     | 4           | Porte de Clignancourt                           |
| Al√©sia                                  | 4                | 3                 | Porte d&#39;Orl√©ans                     | 4           | Porte de Clignancourt                           |
| Al√©sia                                  | 4                | 5                 | Mouton-Duvernet                     | 4           | Porte de Clignancourt                           |
| Al√©sia                                  | 19               | 18                | Mouton-Duvernet                     | 4           | Bagneux - Lucie Aubrac                          |
| Al√©sia                                  | 19               | 20                | Porte d&#39;Orl√©ans                     | 4           | Bagneux - Lucie Aubrac                          |
| Al√©sia                                  | 24               | 23                | Mouton-Duvernet                     | 4           | Bagneux - Lucie Aubrac                          |
| Al√©sia                                  | 24               | 25                | Porte d&#39;Orl√©ans                     | 4           | Bagneux - Lucie Aubrac                          |
</code><!--]--></pre><p><!--[-->On est clairement dans ce cas o√π la ligne est rallong√©e.<!--]--></p><p><!--[-->Bon dans tous les cas √ßa ne change pas les stations adjacentes, mais c&#39;est int√©ressant √† savoir.<!--]--></p><p><!--[-->Pour la version sans doublon :<!--]--></p><pre class="language-sql shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span>SELECT DISTINCT s.stop_name AS station_name,
</span></span><span class="line" line="2"><span>     adjacent_stops_station.stop_name AS adjacent_station_name
</span></span><span class="line" line="3"><span>FROM stop_times AS st
</span></span><span class="line" line="4"><span>INNER JOIN stop_times AS adjacent_stops ON st.trip_id = adjacent_stops.trip_id
</span></span><span class="line" line="5"><span>INNER JOIN stops AS s ON st.stop_id = s.stop_id
</span></span><span class="line" line="6"><span>INNER JOIN stops AS adjacent_stops_station ON adjacent_stops.stop_id = adjacent_stops_station.stop_id
</span></span><span class="line" line="7"><span>INNER JOIN trips AS t ON st.trip_id = t.trip_id
</span></span><span class="line" line="8"><span>INNER JOIN routes AS r ON t.route_id = r.route_id
</span></span><span class="line" line="9"><span>WHERE ABS(st.stop_sequence - adjacent_stops.stop_sequence) = 1
</span></span><span class="line" line="10"><span>AND r.route_type = 1;
</span></span></code><!--]--></pre><p><!--[-->J&#39;obtiens quelque chose comme √ßa :<!--]--></p><pre class="language-text"><!--[--><code>+-----------------------------------------+-----------------------------------------+
| station_name                            | adjacent_station_name                   |
|-----------------------------------------+-----------------------------------------|
| Abbesses                                | Lamarck - Caulaincourt                  |
| Abbesses                                | Pigalle                                 |
| Aim√© C√©saire                            | Front Populaire                         |
| Aim√© C√©saire                            | Mairie d&#39;Aubervilliers                  |
| Alexandre Dumas                         | Avron                                   |
| Alexandre Dumas                         | Philippe Auguste                        |
| Alma - Marceau                          | Franklin D. Roosevelt                   |
| Alma - Marceau                          | I√©na                                    |
| Al√©sia                                  | Mouton-Duvernet                         |
| Al√©sia                                  | Porte d&#39;Orl√©ans                         |
</code><!--]--></pre><p><!--[-->Je n&#39;ai pas besoin du nom des stations, mais uniquement des ids, je peux donc supprimer 2 jointures.<!--]--></p><pre class="language-sql shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span>SELECT DISTINCT st.stop_id AS stop_id,
</span></span><span class="line" line="2"><span>    adjacent_stops.stop_id AS adjacent_stop_id
</span></span><span class="line" line="3"><span>FROM stop_times AS st
</span></span><span class="line" line="4"><span>INNER JOIN stop_times AS adjacent_stops ON st.trip_id = adjacent_stops.trip_id
</span></span><span class="line" line="5"><span>INNER JOIN trips AS t ON st.trip_id = t.trip_id
</span></span><span class="line" line="6"><span>INNER JOIN routes AS r ON t.route_id = r.route_id
</span></span><span class="line" line="7"><span>WHERE ABS(st.stop_sequence - adjacent_stops.stop_sequence) = 1
</span></span><span class="line" line="8"><span>    AND r.route_type = 1
</span></span></code><!--]--></pre><p><!--[-->Par contre, je n&#39;ai pas du tout pris en compte le temps de trajet entre les stations, je vais devoir le faire.<!--]--></p><p><!--[-->J&#39;obtiens :<!--]--></p><pre class="language-sql shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span> SELECT DISTINCT
</span></span><span class="line" line="2"><span>     st.stop_id AS stop_id,
</span></span><span class="line" line="3"><span>     adjacent_stops.stop_id AS adjacent_stop_id,
</span></span><span class="line" line="4"><span>     st.arrival_time::interval - adjacent_stops.arrival_time::interval AS duration,
</span></span><span class="line" line="5"><span>     t.trip_headsign AS trip_headsign,
</span></span><span class="line" line="6"><span>     t.direction_id AS direction_id,
</span></span><span class="line" line="7"><span>     r.route_short_name AS route_name
</span></span><span class="line" line="8"><span> FROM stop_times AS st
</span></span><span class="line" line="9"><span> INNER JOIN stop_times AS adjacent_stops ON st.trip_id = adjacent_stops.trip_id
</span></span><span class="line" line="10"><span> INNER JOIN trips AS t ON st.trip_id = t.trip_id
</span></span><span class="line" line="11"><span> INNER JOIN routes AS r ON t.route_id = r.route_id
</span></span><span class="line" line="12"><span> WHERE ABS(st.stop_sequence - adjacent_stops.stop_sequence) = 1
</span></span><span class="line" line="13"><span>  AND r.route_type = 1;
</span></span></code><!--]--></pre><p><!--[-->Dont voici le r√©sultat :<!--]--></p><pre class="language-text"><!--[--><code>+------------+------------------+------------------+-------------------------------------------------+--------------+------------+
| stop_id    | adjacent_stop_id | duration         | trip_headsign                                   | direction_id | route_name |
|------------+------------------+------------------+-------------------------------------------------+--------------+------------|
| IDFM:21784 | IDFM:463056      | 0:02:00          | Cr√©teil-Pointe du Lac                           | 1            | 8          |
| IDFM:21784 | IDFM:463056      | 0:03:00          | Cr√©teil-Pointe du Lac                           | 1            | 8          |
| IDFM:21902 | IDFM:463250      | -1 day, 23:58:00 | Gallieni (Parc de Bagnolet)                     | 0            | 3          |
| IDFM:21902 | IDFM:463250      | -1 day, 23:59:00 | Gallieni (Parc de Bagnolet)                     | 0            | 3          |
| IDFM:21902 | IDFM:463316      | 0:01:00          | Gallieni (Parc de Bagnolet)                     | 0            | 3          |
| IDFM:21902 | IDFM:463316      | 0:02:00          | Gallieni (Parc de Bagnolet)                     | 0            | 3          |
</code><!--]--></pre><p><!--[-->On peut constater plusieurs soucis, la dur√©e en n√©gatif et surtout pas la dur√©e pour un m√™me trajet.<!--]--></p><p><!--[-->En faisant un case, je r√©sous le probl√®me de la dur√©e n√©gative :<!--]--></p><pre class="language-sql shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span> SELECT DISTINCT
</span></span><span class="line" line="2"><span>     st.stop_id AS stop_id,
</span></span><span class="line" line="3"><span>     adjacent_stops.stop_id AS adjacent_stop_id,
</span></span><span class="line" line="4"><span>     CASE
</span></span><span class="line" line="5"><span>          WHEN st.arrival_time::interval &lt;= adjacent_stops.arrival_time::interval
</span></span><span class="line" line="6"><span>              THEN adjacent_stops.arrival_time::interval - st.arrival_time::interval
</span></span><span class="line" line="7"><span>          ELSE st.arrival_time::interval - adjacent_stops.arrival_time::interval
</span></span><span class="line" line="8"><span>      END AS duration,
</span></span><span class="line" line="9"><span>     t.trip_headsign AS trip_headsign,
</span></span><span class="line" line="10"><span>     t.direction_id AS direction_id,
</span></span><span class="line" line="11"><span>     r.route_short_name AS route_name
</span></span><span class="line" line="12"><span> FROM stop_times AS st
</span></span><span class="line" line="13"><span> INNER JOIN stop_times AS adjacent_stops ON st.trip_id = adjacent_stops.trip_id
</span></span><span class="line" line="14"><span> INNER JOIN trips AS t ON st.trip_id = t.trip_id
</span></span><span class="line" line="15"><span> INNER JOINroutes AS r ON t.route_id = r.route_id
</span></span><span class="line" line="16"><span> WHERE ABS(st.stop_sequence - adjacent_stops.stop_sequence) = 1
</span></span><span class="line" line="17"><span>    AND r.route_type = 1;
</span></span></code><!--]--></pre><p><!--[-->Pour ma culture j&#39;ai voulu voir les arr√™ts les plus longs:<!--]--></p><pre class="language-sql shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span>WITH stops_and_adjacents AS (
</span></span><span class="line" line="2"><span>    SELECT DISTINCT
</span></span><span class="line" line="3"><span>        st.stop_id AS from_stop_id,
</span></span><span class="line" line="4"><span>        s.stop_name AS from_stop_name,
</span></span><span class="line" line="5"><span>        adjacent_stops.stop_id AS to_stop_id,
</span></span><span class="line" line="6"><span>        adjacent_stops_station.stop_name AS to_stop_name,
</span></span><span class="line" line="7"><span>        CASE
</span></span><span class="line" line="8"><span>            WHEN st.arrival_time::interval &lt;= adjacent_stops.arrival_time::interval
</span></span><span class="line" line="9"><span>                THEN (adjacent_stops.arrival_time::interval - st.arrival_time::interval)::TEXT
</span></span><span class="line" line="10"><span>            ELSE (st.arrival_time::interval - adjacent_stops.arrival_time::interval)::TEXT
</span></span><span class="line" line="11"><span>        END AS duration
</span></span><span class="line" line="12"><span>    FROM
</span></span><span class="line" line="13"><span>        stop_times AS st
</span></span><span class="line" line="14"><span>    INNER JOIN
</span></span><span class="line" line="15"><span>        stop_times AS adjacent_stops ON st.trip_id = adjacent_stops.trip_id
</span></span><span class="line" line="16"><span>    INNER JOIN
</span></span><span class="line" line="17"><span>        trips AS t ON st.trip_id = t.trip_id
</span></span><span class="line" line="18"><span>    INNER JOIN stops AS s ON st.stop_id = s.stop_id
</span></span><span class="line" line="19"><span>    INNER JOIN stops AS adjacent_stops_station ON adjacent_stops.stop_id = adjacent_stops_station.stop_id
</span></span><span class="line" line="20"><span>    INNER JOIN
</span></span><span class="line" line="21"><span>        routes AS r ON t.route_id = r.route_id
</span></span><span class="line" line="22"><span>    WHERE
</span></span><span class="line" line="23"><span>        ABS(st.stop_sequence - adjacent_stops.stop_sequence) = 1
</span></span><span class="line" line="24"><span>        AND r.route_type = 1
</span></span><span class="line" line="25"><span>)
</span></span><span class="line" line="26"><span>SELECT
</span></span><span class="line" line="27"><span>    from_stop_id,
</span></span><span class="line" line="28"><span>    from_stop_name,
</span></span><span class="line" line="29"><span>    to_stop_id,
</span></span><span class="line" line="30"><span>    to_stop_name,
</span></span><span class="line" line="31"><span>    MIN(duration) AS min_duration
</span></span><span class="line" line="32"><span>FROM
</span></span><span class="line" line="33"><span>    stops_and_adjacents
</span></span><span class="line" line="34"><span>GROUP BY
</span></span><span class="line" line="35"><span>    from_stop_id,
</span></span><span class="line" line="36"><span>    from_stop_name,
</span></span><span class="line" line="37"><span>    to_stop_id,
</span></span><span class="line" line="38"><span>    to_stop_name
</span></span><span class="line" line="39"><span>ORDER BY min_duration DESC;
</span></span></code><!--]--></pre><p><!--[-->Et voici les r√©sultats :<!--]--></p><pre class="language-text"><!--[--><code>+--------------+-----------------------------------------+-------------+-----------------------------------------+--------------+
| from_stop_id | from_stop_name                          | to_stop_id  | to_stop_name                            | min_duration |
|--------------+-----------------------------------------+-------------+-----------------------------------------+--------------|
| IDFM:463221  | Mairie de Montreuil                     | IDFM:21913  | Porte de Montreuil                      | 00:06:00     |
| IDFM:21913   | Porte de Montreuil                      | IDFM:463221 | Mairie de Montreuil                     | 00:06:00     |
| IDFM:463131  | Bobigny Pablo Picasso                   | IDFM:22014  | Bobigny-Pantin - Raymond Queneau        | 00:04:00     |
| IDFM:22014   | Bobigny-Pantin - Raymond Queneau        | IDFM:463131 | Bobigny Pablo Picasso                   | 00:04:00     |
| IDFM:463002  | Bobigny-Pantin - Raymond Queneau        | IDFM:22015  | Bobigny Pablo Picasso                   | 00:03:00     |
| IDFM:463159  | Ch√¢telet                                | IDFM:21958  | Gare de Lyon                            | 00:03:00     |
| IDFM:21959   | Ch√¢telet                                | IDFM:463046 | Gare de Lyon                            | 00:03:00     |
| IDFM:22015   | Bobigny Pablo Picasso                   | IDFM:463002 | Bobigny-Pantin - Raymond Queneau        | 00:03:00     |
| IDFM:21958   | Gare de Lyon                            | IDFM:463159 | Ch√¢telet                                | 00:03:00     |
| IDFM:463046  | Gare de Lyon                            | IDFM:21959  | Ch√¢telet                                | 00:03:00     |
</code><!--]--></pre><p><!--[-->Ce qui est int√©ressant, c&#39;est que le chemin : Mairie de Montreuil -&gt; Porte de Montreuil, ne devrait pas exister, car il
y a des stations entre les deux.<!--]--></p><p><!--[-->Oups, je me rends compte que ce qui peut m&#39;aider c&#39;est dans la table
<code><!--[-->stop_times<!--]--></code>, il y a un
<code><!--[-->pickup_type<!--]--></code>
et
<code><!--[-->drop_off_type<!--]--></code> mais je n&#39;ai
pas fait la colonne. Je vais devoir la rajouter.<!--]--></p><p><!--[-->D&#39;ailleurs, j&#39;en ai un peu marre de regarder le csv dans TextEdit,
j&#39;installe <a href="https://github.com/YS-L/csvlens" rel="nofollow"><!--[-->csvlens<!--]--></a>, c&#39;est plut√¥t pas mal.<!--]--></p><p><!--[-->En regardant les donn√©es apr√®s avoir ajout√© les colonnes, je me rends qu&#39;il y a pas mal o√π on ne peut pas monter ou
descendre :<!--]--></p><pre class="language-text"><!--[--><code>postgres@localhost:idfm&gt; select count(*), count(*) filter(where drop_off_type = 1), count(*) filter(where pickup_type =1) from stop_times;
+---------+--------+--------+
| count   | count  | count  |
|---------+--------+--------|
| 9761752 | 442360 | 441737 |
+---------+--------+--------+
SELECT 1
Time: 0.958s
</code><!--]--></pre><p><!--[-->En regardant du coup notre cas :<!--]--></p><pre class="language-sql shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span>postgres@localhost:idfm&gt; SELECT DISTINCT
</span></span><span class="line" line="2"><span>         st.stop_id AS from_stop_id,
</span></span><span class="line" line="3"><span>         s.stop_name AS from_stop_name,
</span></span><span class="line" line="4"><span>         adjacent_stops.stop_id AS to_stop_id,
</span></span><span class="line" line="5"><span>         adjacent_stops_station.stop_name AS to_stop_name,
</span></span><span class="line" line="6"><span>         CASE
</span></span><span class="line" line="7"><span>             WHEN st.arrival_time::interval &lt;= adjacent_stops.arrival_time::interval
</span></span><span class="line" line="8"><span>                 THEN (adjacent_stops.arrival_time::interval - st.arrival_time::interval)::TEXT
</span></span><span class="line" line="9"><span>             ELSE (st.arrival_time::interval - adjacent_stops.arrival_time::interval)::TEXT
</span></span><span class="line" line="10"><span>         END AS duration,
</span></span><span class="line" line="11"><span>         st.pickup_type, st.drop_off_type, adjacent_stops.pickup_type, adjacent_stops.drop_off_type
</span></span><span class="line" line="12"><span>     FROM
</span></span><span class="line" line="13"><span>         stop_times AS st
</span></span><span class="line" line="14"><span>     INNER JOIN
</span></span><span class="line" line="15"><span>         stop_times AS adjacent_stops ON st.trip_id = adjacent_stops.trip_id
</span></span><span class="line" line="16"><span>     INNER JOIN
</span></span><span class="line" line="17"><span>         trips AS t ON st.trip_id = t.trip_id
</span></span><span class="line" line="18"><span>     INNER JOIN stops AS s ON st.stop_id = s.stop_id
</span></span><span class="line" line="19"><span>     INNER JOIN stops AS adjacent_stops_station ON adjacent_stops.stop_id = adjacent_stops_station.stop_id
</span></span><span class="line" line="20"><span>     INNER JOIN
</span></span><span class="line" line="21"><span>         routes AS r ON t.route_id = r.route_id
</span></span><span class="line" line="22"><span>     WHERE
</span></span><span class="line" line="23"><span>         ABS(st.stop_sequence - adjacent_stops.stop_sequence) = 1
</span></span><span class="line" line="24"><span>         AND r.route_type = 1 AND st.stop_id = &#39;IDFM:463221&#39;
</span></span><span class="line" line="25"><span>+--------------+---------------------+-------------+--------------------+----------+-------------+---------------+-------------+---------------+
</span></span><span class="line" line="26"><span>| from_stop_id | from_stop_name      | to_stop_id  | to_stop_name       | duration | pickup_type | drop_off_type | pickup_type | drop_off_type |
</span></span><span class="line" line="27"><span>|--------------+---------------------+-------------+--------------------+----------+-------------+---------------+-------------+---------------|
</span></span><span class="line" line="28"><span>| IDFM:463221  | Mairie de Montreuil | IDFM:21913  | Porte de Montreuil | 00:06:00 | 0           | 1             | 1           | 0             |
</span></span><span class="line" line="29"><span>| IDFM:463221  | Mairie de Montreuil | IDFM:463176 | Croix de Chavaux   | 00:01:00 | 0           | 1             | 0           | 0             |
</span></span><span class="line" line="30"><span>| IDFM:463221  | Mairie de Montreuil | IDFM:463176 | Croix de Chavaux   | 00:02:00 | 0           | 1             | 0           | 0             |
</span></span><span class="line" line="31"><span>+--------------+---------------------+-------------+--------------------+----------+-------------+---------------+-------------+---------------+
</span></span></code><!--]--></pre><p><!--[-->Donc ce qu&#39;on peut voir c&#39;est qu&#39;√† Mairie de Montreuil, c&#39;est un arr√™t o√π on peut que monter, mais on ne peut pas
descendre (le train doit faire une boucle ou autres). Et √† son arriv√©e √† Porte de Montreuil, on ne peut que descendre.<!--]--></p><p><!--[-->On est vraiment dans un cas √† la marge, je pense. Est-ce que je ne pourrais pas avoir tous les bouts de lignes pour
√©viter ce genre de cas ?<!--]--></p><h3 id="adjacents-sur-une-correspondance"><a href="#adjacents-sur-une-correspondance"><!--[-->Adjacents sur une correspondance<!--]--></a></h3><p><!--[-->Exemple : Saint-Lazare : Je peux changer de la ligne 13 √† la 12, 14, ‚Ä¶<!--]--></p><p><!--[-->Il faut donc r√©cup√©rer les
<code><!--[-->pathways<!--]--></code> et les
<code><!--[-->stops<!--]--></code> pour avoir les correspondances.<!--]--></p><h2 id="ressources"><a href="#ressources"><!--[-->Ressources<!--]--></a></h2><ul><!--[--><li><!--[--><a href="https://2ality.com/2019/11/nodejs-streams-async-iteration.html" rel="nofollow"><!--[-->Easier Node.js streams via async iteration<!--]--></a><!--]--></li><li><!--[--><a href="https://github.com/YS-L/csvlens" rel="nofollow"><!--[-->csvlens<!--]--></a><!--]--></li><!--]--></ul><style>html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .sVt8B, html code.shiki .sVt8B{--shiki-default:#24292E;--shiki-dark:#E1E4E8}html pre.shiki code .sj4cs, html code.shiki .sj4cs{--shiki-default:#005CC5;--shiki-dark:#79B8FF}html pre.shiki code .sZZnC, html code.shiki .sZZnC{--shiki-default:#032F62;--shiki-dark:#9ECBFF}</style></div></article><!--]--><footer class="fixed bottom-5 left-1/2 transform -translate-x-1/2 text-gray-500 dark:text-gray-400 text-sm bg-white/80 dark:bg-gray-800/80 backdrop-blur-lg px-4 py-1 rounded-full shadow max-w-[calc(100%-2rem)] z-10 transition-colors duration-300 flex items-center justify-center gap-1 flex-nowrap whitespace-nowrap"> ¬© 2025 <a href="https://github.com/VincentHardouin/metro-travel" class="hover:underline">Metro Travel</a> ‚Äì par <a href="https://vincenthardouin.dev" class="hover:underline">Vincent Hardouin</a></footer></body></div></div><div id="teleports"></div><script type="application/json" data-nuxt-data="nuxt-app" data-ssr="true" id="__NUXT_DATA__" data-src="/blog/2024-03-27/_payload.json?d002b2d4-7063-42d0-8888-5547bfabd298">[{"state":1,"once":3,"_errors":4,"serverRendered":6,"path":7,"prerenderedAt":8},["Reactive",2],{},["Set"],["ShallowReactive",5],{"/blog/2024-03-27":-1},true,"/blog/2024-03-27",1752417582968]</script><script>window.__NUXT__={};window.__NUXT__.config={public:{content:{wsUrl:""},mdc:{components:{prose:true,map:{}},headings:{anchorLinks:{h1:false,h2:true,h3:true,h4:true,h5:false,h6:false}}}},app:{baseURL:"/",buildId:"d002b2d4-7063-42d0-8888-5547bfabd298",buildAssetsDir:"/_nuxt/",cdnURL:""}}</script></body></html>